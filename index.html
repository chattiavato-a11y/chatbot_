<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OPS Online Assistant</title>

<!-- FontAwesome (CSP + SRI + CORS Safe) -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-RXf+QSDCUqpphKAa+WAc3XQ8fE5H1aO/8e2wY+8Q1n8yVwDh1RZTf1TDN8E+u1n7eU5KyY7X2Qo+hqeZZn+UAQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* ---------- COLOR SYSTEM ---------- */
:root{
  --clr-primary:#00c4ff;
  --clr-accent :#ff3bdb;
  --clr-accent-dark:#e000be;
  --clr-bg  :#ffffff;
  --clr-bg-dark:#121212;
  --clr-tx  :#333333;
  --clr-tx-dark:#f0f0f0;
}
body{
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--clr-bg);
  color:var(--clr-tx);
  transition:background .3s,color .3s;
}
body.dark{
  --clr-bg:var(--clr-bg-dark);
  --clr-tx:var(--clr-tx-dark);
}

/* ---------- CHATBOT ---------- */
#chatbot-container{
  width:300px;
  height:540px;
  background:#251541;
  border:2px solid var(--clr-accent);
  border-radius:18px;
  box-shadow:0 8px 32px #0006;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#chatbot-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.5rem;
  background:linear-gradient(135deg,var(--clr-primary) 0%,var(--clr-accent) 100%);
  color:#fff;
  font-weight:600;
  font-size:1.05rem;
  padding:.6rem .8rem;
}
#chatbot-header .ctrl{
  cursor:pointer;
  font-size:.7rem;
  font-weight:500;
  user-select:none;
  opacity:.85;
}
#chatbot-header .ctrl:hover{opacity:1}
#chatbot-header .ctrl-group{
  display:flex;
  align-items:center;
  gap:.3rem;
  font-size:.7rem;
}

#chat-log{
  flex:1;
  overflow-y:auto;
  padding:1rem;
  background:#1b0e2d;
  color:#eee;
  font-size:.94rem;
}
.chat-msg{
  margin:.5rem 0;
  max-width:90%;
  word-wrap:break-word;
}
.user{
  margin-left:auto;
  background:var(--clr-primary);
  color:#000;
  padding:.5rem .7rem;
  border-radius:14px 14px 0 14px;
}
.bot{
  margin-right:auto;
  background:#321b53;
  color:#fff;
  padding:.5rem .7rem;
  border-radius:14px 14px 14px 0;
}
#chatbot-form-container{
  background:#220f3a;
  border-top:1px solid var(--clr-accent);
  padding:.55rem .7rem;
}
#chatbot-input-row{
  display:flex;
  gap:.6rem;
}
#chatbot-input{
  flex:1;
  background:transparent;
  border:none;
  color:#fff;
  font-size:.95rem;
  padding:.55rem .6rem;
}
#chatbot-input:focus{
  outline:none;
}
#chatbot-send{
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--clr-accent);
  border:none;
  color:#fff;
  font-weight:600;
  padding:.5rem .9rem;
  border-radius:8px;
  cursor:pointer;
  transition:.3s;
}
#chatbot-send i{transition:transform .3s}
#chatbot-send:hover i{transform:rotate(-45deg)}
#chatbot-send:disabled{
  background:#555;
  cursor:not-allowed;
}

@media(max-width:480px){
  #chatbot-container{
    height:75vh;
    width:90%;
  }
}
</style>
</head>
<body>

<!-- ---------- CHATBOT HTML ---------- -->
<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header">
    <span id="title"
          data-en="OPS Online Assistant"
          data-es="Asistente OPS en Línea">
      OPS Online Assistant
    </span>

    <!-- tiny controls -->
    <div class="ctrl-group">
      <span id="langCtrl"  class="ctrl">ES</span>
      <span>•</span>
      <span id="themeCtrl" class="ctrl">Dark</span>
      <span>•</span>
      <span id="resetCtrl" class="ctrl">Reset</span>
    </div>
  </div>

  <div id="chat-log" aria-live="polite"></div>

  <div id="chatbot-form-container">
    <form id="chatbot-input-row" autocomplete="off">
      <input id="chatbot-input" type="text" required maxlength="256"
             placeholder="Ask about OPS services..."
             data-en-ph="Ask about OPS services..."
             data-es-ph="Pregunte sobre servicios OPS...">
      <button id="chatbot-send" type="submit" aria-label="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<!-- ---------- CHATBOT LOGIC ---------- -->
<script>
// ====== Helpers & config ======
const qs  = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];

const API_URL     = "https://ops-online-assistant.grabem-holdem-nuts-right.workers.dev/api/ops-online-chat";
const STORAGE_KEY = "ops_online_history_v1";

// ====== Language toggle ======
const langCtrl   = qs('#langCtrl');
const transNodes = qsa('[data-en]');
const phNodes    = qsa('[data-en-ph]');

langCtrl.onclick = () => {
  const toES = (langCtrl.textContent === 'ES'); // going EN→ES ?
  document.documentElement.lang = toES ? 'es' : 'en';
  langCtrl.textContent = toES ? 'EN' : 'ES';

  // static text
  transNodes.forEach(node => {
    if (node.dataset.en && node.dataset.es) {
      node.textContent = toES ? node.dataset.es : node.dataset.en;
    }
  });

  // placeholders
  phNodes.forEach(node => {
    const enPh = node.dataset.enPh;
    const esPh = node.dataset.esPh;
    if (toES && esPh) node.placeholder = esPh;
    else if (!toES && enPh) node.placeholder = enPh;
  });
};

// ====== Theme toggle ======
const themeCtrl = qs('#themeCtrl');
themeCtrl.onclick = () => {
  const dark = themeCtrl.textContent === 'Dark';
  document.body.classList.toggle('dark', dark);
  themeCtrl.textContent = dark ? 'Light' : 'Dark';
};

// ====== Web Speech Synthesis (improved) ======
let englishVoice = null;
let spanishVoice = null;

function pickVoices() {
  if (!("speechSynthesis" in window)) return;
  const voices = window.speechSynthesis.getVoices();
  if (!voices || !voices.length) return;

  // Prefer Google voices if available, then any EN/ES
  englishVoice =
    voices.find(v => v.lang.startsWith("en-US") && v.name.includes("Google")) ||
    voices.find(v => v.lang.startsWith("en-")) ||
    null;

  spanishVoice =
    voices.find(v => v.lang.startsWith("es-") && v.name.includes("Google")) ||
    voices.find(v => v.lang.startsWith("es-")) ||
    null;
}

if ("speechSynthesis" in window) {
  window.speechSynthesis.onvoiceschanged = pickVoices;
  pickVoices();
}

function cleanForSpeech(text) {
  if (!text) return "";
  let t = String(text);

  // Remove fenced code blocks ```...```
  t = t.replace(/```[\s\S]*?```/g, " ");

  // Remove inline code `like this`
  t = t.replace(/`([^`]+)`/g, "$1");

  // Replace Markdown bullets at line starts
  t = t.replace(/^\s*[-*+]\s+/gm, "• ");

  // Remove emphasis markers *word* or _word_
  t = t.replace(/(\s)[*_]+([^*_]+)[*_]+(\s)/g, "$1$2$3");

  // Turn "SLA/CSAT/NPS" into "SLA, CSAT, NPS"
  t = t.replace(/([A-Za-z0-9])\/([A-Za-z0-9])/g, "$1, $2");

  // Normalize newlines to sentence breaks
  t = t.replace(/\r/g, "");
  t = t.replace(/\n{2,}/g, ". ");
  t = t.replace(/\n/g, " ");

  // Collapse multiple spaces
  t = t.replace(/\s{2,}/g, " ");

  return t.trim();
}

function speak(text) {
  if (typeof window === "undefined" || !("speechSynthesis" in window)) return;
  if (!text) return;

  try {
    const langAttr = (document.documentElement.lang || "en").toLowerCase();
    const isEs = langAttr.startsWith("es");

    const cleaned = cleanForSpeech(text);
    if (!cleaned) return;

    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(cleaned);
    u.lang = isEs ? "es-ES" : "en-US";

    if (isEs && spanishVoice) u.voice = spanishVoice;
    if (!isEs && englishVoice) u.voice = englishVoice;

    // Slightly smoother English
    if (isEs) {
      u.rate = 1.0;
      u.pitch = 1.0;
    } else {
      u.rate = 0.95;
      u.pitch = 1.02;
    }

    window.speechSynthesis.speak(u);
  } catch (e) {
    console.warn("Speech synthesis error:", e);
  }
}

// ====== Chat state + history cache ======
const log       = qs('#chat-log');
const form      = qs('#chatbot-input-row');
const input     = qs('#chatbot-input');
const send      = qs('#chatbot-send');
const resetCtrl = qs('#resetCtrl');

let chatHistory = []; // { role: 'user' | 'assistant', content: string }

function addMsg(txt, cls){
  const div = document.createElement('div');
  div.className = 'chat-msg ' + cls;
  div.textContent = txt;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  return div;
}

function saveHistory(){
  try{
    const trimmed = chatHistory.slice(-40); // keep last 40 turns
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmed));
  }catch(e){
    console.warn("Cannot save history:", e);
  }
}

function loadHistory(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return;
    chatHistory = arr;
    log.innerHTML = "";
    for(const msg of chatHistory){
      addMsg(msg.content, msg.role === "assistant" ? "bot" : "user");
    }
  }catch(e){
    console.warn("Cannot load history:", e);
  }
}

// Reset button: clear history + UI + stop speech
resetCtrl.onclick = () => {
  chatHistory = [];
  log.innerHTML = "";
  try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
};

// ====== Chat submit logic (OPS-only enforced in Worker) ======
form.onsubmit = async (e) => {
  e.preventDefault();
  const msg = input.value.trim();
  if(!msg) return;

  // user bubble
  addMsg(msg, 'user');
  chatHistory.push({ role:'user', content:msg });
  saveHistory();
  input.value = "";
  input.focus();

  const placeholder = addMsg('…', 'bot');
  send.disabled = true;

  try{
    const body = {
      message: msg,
      history: chatHistory
    };

    const r = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });

    const langIsEs = (document.documentElement.lang || "en")
      .toLowerCase()
      .startsWith("es");

    if(!r.ok){
      const errText = langIsEs
        ? "Error: no se pudo contactar a OPS Online Assistant."
        : "Error: couldn’t reach OPS Online Assistant.";
      placeholder.textContent = errText;
      chatHistory.push({ role:'assistant', content:errText });
      saveHistory();
      speak(errText);
      return;
    }

    const d = await r.json().catch(() => ({}));
    const reply = d.reply || (langIsEs
      ? "Por ahora no tengo una respuesta mejor sobre este tema."
      : "I don’t have a better answer for this topic yet.");

    placeholder.textContent = reply;
    chatHistory.push({ role:'assistant', content:reply });
    saveHistory();
    speak(reply);
  }catch(err){
    console.error(err);
    const langIsEs = (document.documentElement.lang || "en")
      .toLowerCase()
      .startsWith("es");
    const errText = langIsEs
      ? "Error: no se pudo contactar a OPS Online Assistant."
      : "Error: couldn’t reach OPS Online Assistant.";
    placeholder.textContent = errText;
    chatHistory.push({ role:'assistant', content:errText });
    saveHistory();
    speak(errText);
  }finally{
    send.disabled = false;
  }
};

// ====== Initial load ======
loadHistory();
</script>
</body>
</html>
