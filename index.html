<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OPS AI Chatbot</title>

<!-- ✅ CSP updated:
     - adds frame-ancestors (note: meta version is a warning; real enforcement requires HTTP header)
     - allows ONLY this inline script via the hash below
     - keeps connect-src to your gateway
-->
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
    base-uri 'self';
    object-src 'none';
    frame-ancestors 'self';
    script-src 'self' 'sha256-PNRT7X5j6A2nsUN5thtpONlowxYq4Whijr4FaSiL6Y0=';
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    connect-src 'self' https://ops-gateway.grabem-holdem-nuts-right.workers.dev;
    img-src 'self' data:;
    font-src 'self' https://cdnjs.cloudflare.com data:;
    frame-src 'self';">

<meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy"
  content="camera=(), microphone=(), geolocation=(), payment=(), interest-cohort=()">
<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
<meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

<!-- ✅ FontAwesome SRI fixed to match DevTools computed SHA-512 -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* ---------- COLOR SYSTEM ---------- */
:root {
  --clr-primary:#00c4ff;
  --clr-accent:#ff3bdb;
  --clr-bg:#ffffff;
  --clr-bg-dark:#121212;
  --clr-tx:#333333;
  --clr-tx-dark:#f0f0f0;
}
body {
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--clr-bg);
  color:var(--clr-tx);
  transition:background .3s,color .3s;
}
body.dark {
  --clr-bg:var(--clr-bg-dark);
  --clr-tx:var(--clr-tx-dark);
}

/* ---------- CHATBOT ---------- */
#chatbot-container {
  width:300px;
  height:540px;
  background:#251541;
  border:2px solid var(--clr-accent);
  border-radius:18px;
  box-shadow:0 8px 32px #0006;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#chatbot-header {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:.5rem;
  background:linear-gradient(135deg,var(--clr-primary) 0%,var(--clr-accent) 100%);
  color:#fff;
  font-weight:600;
  font-size:1.1rem;
  padding:.75rem 1rem;
}
.ctrl-group {
  display:flex;
  align-items:center;
  gap:.35rem;
  flex-wrap:wrap;
}
.ctrl {
  cursor:pointer;
  font-size:.75rem;
  font-weight:600;
  user-select:none;
  opacity:.9;
  color:#fff;
  background:#321b53;
  border:1px solid #fff3;
  border-radius:6px;
  padding:.25rem .55rem;
  transition:background .2s, color .2s, opacity .2s, box-shadow .2s;
}
.ctrl:hover {
  opacity:1;
  background:#3d2264;
}
.ctrl.active {
  background:#fff;
  color:#321b53;
  opacity:1;
  box-shadow:0 0 0 1px #fff4;
}
#chat-log {
  flex:1;
  overflow-y:auto;
  padding:1rem;
  background:#1b0e2d;
  color:#eee;
  font-size:.94rem;
}
.chat-msg {
  margin:.5rem 0;
  max-width:90%;
}
.user {
  margin-left:auto;
  background:var(--clr-primary);
  color:#000;
  padding:.5rem .7rem;
  border-radius:14px 14px 0 14px;
}
.bot {
  margin-right:auto;
  background:#321b53;
  color:#fff;
  padding:.5rem .7rem;
  border-radius:14px 14px 14px 0;
}
#chatbot-form-container {
  background:#220f3a;
  border-top:1px solid var(--clr-accent);
  padding:.55rem .7rem .75rem;
  color:#fff;
}
#control-row {
  display:flex;
  justify-content:flex-start;
  margin-bottom:.55rem;
}
#chatbot-input-row {
  display:flex;
  gap:.6rem;
}
#listenCtrl {
  background:#ffb703;
  border:none;
  color:#1b0e2d;
  font-weight:700;
  padding:.45rem .65rem;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform .2s, box-shadow .2s;
}
#listenCtrl .btn-label {
  margin-left:.35rem;
  font-weight:700;
}
#listenCtrl.active {
  box-shadow:0 0 0 2px #fff3;
  transform:scale(1.02);
}
#listenCtrl i { pointer-events:none; }
#chatbot-input {
  flex:1;
  background:transparent;
  border:none;
  color:#fff;
  font-size:.95rem;
  padding:.55rem .6rem;
}
#chatbot-input::placeholder {
  color:#bfbfbf;
}
#chatbot-send {
  display:flex;
  align-items:center;
  gap:6px;
  background:var(--clr-accent);
  border:none;
  color:#fff;
  font-weight:600;
  padding:.5rem .9rem;
  border-radius:8px;
  cursor:pointer;
  transition:.3s;
}
#chatbot-send i {
  transition:transform .3s;
}
#chatbot-send:hover i {
  transform:rotate(-45deg);
}
#tnc-row {
  display:flex;
  justify-content:flex-end;
  margin-top:.4rem;
}
#tnc-trigger {
  background:transparent;
  color:#fff;
  border:1px solid #ffffff40;
  border-radius:8px;
  padding:.35rem .7rem;
  font-weight:600;
  cursor:pointer;
  transition:background .2s, color .2s, border-color .2s;
}
#tnc-trigger:hover,
#tnc-trigger:focus-visible {
  background:#ffffff12;
  border-color:#ffffff70;
}
#tnc-modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.75);
  backdrop-filter:blur(2px);
  z-index:2000;
}
#tnc-modal.active { display:flex; }
#tnc-dialog {
  background:#f8f8ff;
  color:#1b0e2d;
  width:92%;
  max-width:520px;
  border-radius:16px;
  padding:1.4rem 1.2rem 1.2rem;
  box-shadow:0 12px 36px rgba(0,0,0,0.35);
  border:2px solid var(--clr-primary);
}
#tnc-dialog h3 {
  margin-top:0;
  margin-bottom:.6rem;
  color:#1b0e2d;
}
#tnc-dialog p {
  margin:.35rem 0;
  line-height:1.5;
}
#consent-banner {
  background:#0d0b1e;
  color:#f5f7fb;
  border:2px solid var(--clr-primary);
  border-radius:14px;
  padding:1rem 1.25rem;
  margin:0 0 1rem;
  box-shadow:0 10px 25px #0005;
}
#consent-banner a {
  color:var(--clr-primary);
  font-weight:600;
}
#consent-banner .consent-row {
  display:flex;
  align-items:center;
  gap:.65rem;
  margin-top:.75rem;
  flex-wrap:wrap;
}
#consentToggle {
  width:18px;
  height:18px;
}
#consent-status {
  font-size:.95rem;
}
#tnc-close {
  display:inline-flex;
  align-items:center;
  gap:.25rem;
  margin-top:1rem;
  background:var(--clr-primary);
  color:#0d0b1e;
  border:none;
  border-radius:10px;
  padding:.45rem .8rem;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}
#tnc-close i { font-size:.9rem; }

@media (max-width:480px) {
  #chatbot-container {
    height:75vh;
    width:90%;
  }
}
</style>
</head>
<body>

<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header">
    <span id="title"
          data-en="OPS AI Chatbot"
          data-es="Chatbot OPS AI">OPS AI Chatbot</span>
  </div>

  <div id="chat-log" aria-live="polite"></div>

  <div id="chatbot-form-container">
    <div id="control-row" class="ctrl-group" aria-label="Language, theme, and speech controls">
      <button type="button" id="langCtrl" class="ctrl"
        aria-label="Toggle language"
        data-en-label="Toggle language"
        data-es-label="Cambiar idioma">EN</button>
      <button type="button" id="themeCtrl" class="ctrl">Dark</button>
      <button type="button" id="speechToggle" class="ctrl"
        data-en="Speech"
        data-es="Voz">Speech</button>
      <button id="listenCtrl" type="button" aria-label="Start voice input"
        data-en-label="Start voice input"
        data-es-label="Comenzar voz">
        <i class="fas fa-microphone"></i>
        <span class="btn-label" data-en="Speak" data-es="Hablar">Speak</span>
      </button>
    </div>
    <form id="chatbot-input-row" autocomplete="off">
      <input
        id="chatbot-input"
        type="text"
        placeholder="Type your message..."
        required
        maxlength="256"
        data-en-ph="Type your message..."
        data-es-ph="Escriba su mensaje...">
      <button id="chatbot-send" type="submit" aria-label="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
    <div id="tnc-row">
      <button
        id="tnc-trigger"
        type="button"
        aria-haspopup="dialog"
        aria-controls="tnc-modal"
        data-en="Consent Notice"
        data-es="Aviso de consentimiento">
        Consent Notice
      </button>
    </div>
  </div>
</div>

<div id="tnc-modal" role="dialog" aria-modal="true" aria-labelledby="tnc-title" aria-hidden="true">
  <div id="tnc-dialog">
    <h3
      id="tnc-title"
      data-en="Consent Notice &amp; Terms"
      data-es="Aviso de consentimiento y términos">
      Consent Notice &amp; Terms
    </h3>
    <div id="consent-banner" role="region" aria-live="polite">
      <p
        data-en="We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our"
        data-es="Procesamos tu chat y la entrada de voz opcional para responder. El audio permanece en tu navegador; los mensajes escritos se envían a nuestro servicio. Revisa nuestra">
        We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our
        <a href="#" target="_blank" rel="noreferrer noopener">Privacy Policy</a>
        &amp;
        <a href="#" target="_blank" rel="noreferrer noopener">Terms of Service</a>
        before proceeding.
      </p>
      <p
        data-en="Grant consent to enable voice controls and sending messages to the assistant."
        data-es="Otorga consentimiento para activar los controles de voz y el envío de mensajes al asistente.">
        Grant consent to enable voice controls and sending messages to the assistant.
      </p>
      <div class="consent-row">
        <label for="consentToggle" data-en="I consent to send my messages for processing." data-es="Consiento enviar mis mensajes para su procesamiento.">
          I consent to send my messages for processing.
        </label>
        <input type="checkbox" id="consentToggle" aria-describedby="consent-status">
        <span id="consent-status"></span>
      </div>
    </div>
    <button id="tnc-close" type="button" aria-label="Close terms dialog">
      <i class="fas fa-check"></i>
      Close
    </button>
  </div>
</div>

<script>
const qs  = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];

/* ===== Fixed asset ID: repo → gateway (ONLY) ===== */
const ASSET_ID = "CAFF600A21B457E5D909FD887AF48018B3CBFDDF6F9746E56238B23AF061F9E2";

/* ===== Expected origin (GitHub Pages) ===== */
const EXPECTED_ORIGIN = "https://chattiavato-a11y.github.io";

/* ===== Backend endpoint: repo → gateway ===== */
const API_URL = new URL("https://ops-gateway.grabem-holdem-nuts-right.workers.dev/api/ops-online-chat");

/* ===== Language / UI wiring ===== */
const langCtrl     = qs('#langCtrl');
const transNodes   = qsa('[data-en]');
const phNodes      = qsa('[data-en-ph]');
const ariaNodes    = qsa('[data-en-label]');

const themeCtrl     = qs('#themeCtrl');
const speechToggle  = qs('#speechToggle');
const listenCtrl    = qs('#listenCtrl');

const log   = qs('#chat-log');
const form  = qs('#chatbot-input-row');
const input = qs('#chatbot-input');

const consentToggle = qs('#consentToggle');
const consentStatus = qs('#consent-status');
const sendBtn       = qs('#chatbot-send');

const tncTrigger = qs('#tnc-trigger');
const tncModal   = qs('#tnc-modal');
const tncClose   = qs('#tnc-close');

const CONSENT_KEY = 'opsChatConsent_v1';
let consentGranted = localStorage.getItem(CONSENT_KEY) === 'true';

let currentLang = document.documentElement.lang === 'es' ? 'es' : 'en';

const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = Recognition ? new Recognition() : null;

let listening = false;
let speechEnabled = false;

/* ===== UI + Security Helpers ===== */

function normalizeUserText(s) {
  // Normalize whitespace and strip control chars (keeps accents)
  let out = String(s || '');
  out = out.replace(/[\u0000-\u001F\u007F]/g, ' ');
  out = out.replace(/\s+/g, ' ').trim();
  return out;
}

function looksSuspicious(s) {
  const t = String(s || '').toLowerCase();
  const bad = [
    "<script", "</script", "javascript:",
    "<img", "onerror", "onload",
    "<iframe", "<object", "<embed",
    "<svg", "<link", "<meta", "<style",
    "document.cookie",
    "onmouseover", "onmouseenter",
    "<form", "<input", "<textarea"
  ];
  return bad.some(p => t.includes(p));
}

function requireConsentMessage() {
  return currentLang === 'es'
    ? 'Activa el consentimiento para usar voz o enviar mensajes.'
    : 'Please enable consent to use voice or send messages.';
}

function addMsg(txt, cls) {
  const div = document.createElement('div');
  div.className = 'chat-msg ' + cls;
  div.textContent = txt;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  return div;
}

function updateSpeechToggleUI() {
  speechToggle.classList.toggle('active', speechEnabled);
  speechToggle.setAttribute('aria-pressed', speechEnabled ? 'true' : 'false');
}

function updateListenUI() {
  listenCtrl.classList.toggle('active', listening);
  listenCtrl.setAttribute('aria-pressed', listening ? 'true' : 'false');
}

function updateConsentUI() {
  consentToggle.checked = consentGranted;

  const consentNeeded = !consentGranted;
  speechToggle.disabled = consentNeeded;
  listenCtrl.disabled = consentNeeded;
  sendBtn.disabled = consentNeeded;
  input.disabled = consentNeeded;

  const statusText = consentGranted
    ? (currentLang === 'es'
      ? 'Consentimiento activo: puedes usar voz y enviar mensajes.'
      : 'Consent granted: voice and messages are enabled.')
    : (currentLang === 'es'
      ? 'Activa el consentimiento para habilitar voz y envíos.'
      : 'Turn on consent to enable voice and sending.');

  consentStatus.textContent = statusText;
  consentStatus.setAttribute('aria-live', 'polite');
}

function setConsent(granted) {
  consentGranted = !!granted;
  localStorage.setItem(CONSENT_KEY, consentGranted ? 'true' : 'false');
  updateConsentUI();
}

function openTncDialog() {
  if (!tncModal) return;
  tncModal.classList.add('active');
  tncModal.setAttribute('aria-hidden', 'false');
  tncClose?.focus();
}

function closeTncDialog() {
  if (!tncModal) return;
  tncModal.classList.remove('active');
  tncModal.setAttribute('aria-hidden', 'true');
  tncTrigger?.focus();
}

/* ===== Origin lock (repo must run ONLY from official GH Pages origin) ===== */
let originLocked = false;
if (window.location.origin !== EXPECTED_ORIGIN) {
  originLocked = true;
  addMsg(
    "OPS assistant only works from " + EXPECTED_ORIGIN + "/ops-online-support/ for security reasons.",
    "bot"
  );
}

/* ===== Speech synthesis ===== */

function getVoiceForLang(langCode) {
  if (!synth) return null;
  const voices = synth.getVoices();
  const want = langCode === 'es'
    ? ['es-', 'es_']
    : ['en-', 'en_'];

  // Prefer local voices and common high-quality ones when available
  const preferred = voices
    .filter(v => want.some(p => (v.lang || '').toLowerCase().startsWith(p)))
    .sort((a, b) => {
      const aScore = (a.localService ? 2 : 0) + (/google|microsoft|natural/i.test(a.name) ? 1 : 0);
      const bScore = (b.localService ? 2 : 0) + (/google|microsoft|natural/i.test(b.name) ? 1 : 0);
      return bScore - aScore;
    });

  return preferred[0] || null;
}

function speak(text) {
  if (!synth || !speechEnabled) return;
  const clean = normalizeUserText(text);
  if (!clean) return;

  synth.cancel();

  const utter = new SpeechSynthesisUtterance(clean);
  utter.lang = currentLang === 'es' ? 'es-ES' : 'en-US';

  const voice = getVoiceForLang(currentLang);
  if (voice) utter.voice = voice;

  // Slight smoothing for English (often sounds robotic)
  if (currentLang === 'en') {
    utter.rate = 1.03;
    utter.pitch = 1.02;
  } else {
    utter.rate = 1.0;
    utter.pitch = 1.0;
  }

  synth.speak(utter);
}

if (synth) {
  synth.onvoiceschanged = () => getVoiceForLang(currentLang);
}

/* ===== Speech recognition (dictation) ===== */

if (recognition) {
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = currentLang === 'es' ? 'es-ES' : 'en-US';

  recognition.onresult = event => {
    const transcript = event.results?.[0]?.[0]?.transcript || '';
    const cleaned = normalizeUserText(transcript);
    if (cleaned) {
      input.value = cleaned;   // Dictation into the input box
      input.focus();
    }
  };

  recognition.onerror = () => {
    listening = false;
    updateListenUI();
  };

  recognition.onend = () => {
    listening = false;
    updateListenUI();
  };
}

function startListening() {
  if (!recognition) return;
  recognition.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
  listening = true;
  updateListenUI();
  recognition.start();
}

/* ===== Language toggle ===== */

function setLanguage(lang) {
  const toES = lang === 'es';
  currentLang = toES ? 'es' : 'en';
  document.documentElement.lang = currentLang;

  langCtrl.textContent = toES ? 'ES' : 'EN';
  langCtrl.setAttribute('aria-pressed', toES ? 'true' : 'false');
  langCtrl.classList.toggle('active', toES);

  transNodes.forEach(node => {
    node.textContent = toES ? node.dataset.es : node.dataset.en;
  });

  phNodes.forEach(node => {
    node.placeholder = toES ? node.dataset.esPh : node.dataset.enPh;
  });

  ariaNodes.forEach(node => {
    node.setAttribute('aria-label', toES ? node.dataset.esLabel : node.dataset.enLabel);
  });

  if (recognition) recognition.lang = toES ? 'es-ES' : 'en-US';

  updateConsentUI();
}

langCtrl.addEventListener('click', () => {
  setLanguage(currentLang === 'es' ? 'en' : 'es');
});

/* ===== Consent + Terms modal ===== */

consentToggle.addEventListener('change', () => setConsent(consentToggle.checked));

if (tncTrigger && tncModal && tncClose) {
  tncTrigger.addEventListener('click', openTncDialog);
  tncClose.addEventListener('click', closeTncDialog);
  tncModal.addEventListener('click', e => {
    if (e.target === tncModal) closeTncDialog();
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && tncModal.classList.contains('active')) {
      closeTncDialog();
    }
  });
}

/* ===== Theme toggle ===== */

themeCtrl.onclick = () => {
  const dark = themeCtrl.textContent === 'Dark';
  document.body.classList.toggle('dark', dark);
  themeCtrl.textContent = dark ? 'Light' : 'Dark';
};

/* ===== Speech toggle ===== */

speechToggle.onclick = () => {
  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }
  if (!synth) {
    addMsg(currentLang === 'es'
      ? 'La síntesis de voz no está disponible.'
      : 'Speech synthesis is not available.', 'bot');
    return;
  }
  speechEnabled = !speechEnabled;
  updateSpeechToggleUI();
};

/* ===== Listen (dictation) toggle ===== */

listenCtrl.onclick = () => {
  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }
  if (!recognition) {
    addMsg(currentLang === 'es'
      ? 'Entrada por voz no disponible en este navegador.'
      : 'Voice input is not available in this browser.', 'bot');
    return;
  }

  if (listening) {
    recognition.stop();
    return;
  }

  startListening();
};

/* ===== Init ===== */

setLanguage(currentLang);
updateSpeechToggleUI();
updateListenUI();
updateConsentUI();

/* ===== Submit: repo → gateway (asset id + JSON) ===== */

form.onsubmit = async e => {
  e.preventDefault();

  const raw = input.value;
  const msg = normalizeUserText(raw);
  if (!msg) return;

  if (!consentGranted) {
    addMsg(requireConsentMessage(), 'bot');
    return;
  }

  // If origin is not the official one, do not talk to gateway
  if (originLocked) {
    addMsg(
      currentLang === 'es'
        ? 'Por seguridad, el asistente solo está disponible desde la página oficial.'
        : 'For security, the assistant is only available from the official site.',
      'bot'
    );
    return;
  }

  // Local (client-side) anti-injection check (gateway will re-check)
  if (looksSuspicious(msg)) {
    const warn = currentLang === 'es'
      ? 'Mensaje bloqueado por seguridad. Por favor escribe sin etiquetas o scripts.'
      : 'Message blocked for security. Please write without tags or scripts.';
    addMsg(warn, 'bot');
    speak(warn);
    return;
  }

  const lang = currentLang;

  // user bubble
  addMsg(msg, 'user');
  input.value = '';

  // temporary bot bubble
  const botDiv = addMsg('…', 'bot');

  try {
    const res = await fetch(API_URL.href, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Ops-Asset-Id': ASSET_ID
      },
      body: JSON.stringify({ message: msg, lang })
    });

    const responseText = await res.text();
    let data = null;
    try { data = JSON.parse(responseText); } catch {}

    if (!res.ok) {
      const fallback = (lang === 'es') ? 'Error del gateway de OPS.' : 'OPS gateway error.';
      const errorMsg = (data && (data.error || data.public_error)) ? (data.error || data.public_error) : (responseText || fallback);
      botDiv.textContent = errorMsg;
      speak(errorMsg);
      return;
    }

    if (!data || typeof data !== 'object') {
      const fallback = (lang === 'es')
        ? 'Error: respuesta no válida del gateway.'
        : 'Error: invalid response from gateway.';
      botDiv.textContent = fallback;
      speak(fallback);
      return;
    }

    if (data.error || data.public_error) {
      const errMsg = data.error || data.public_error;
      botDiv.textContent = errMsg;
      speak(errMsg);
      return;
    }

    const reply = (typeof data.reply === 'string' && data.reply.trim())
      ? data.reply.trim()
      : (lang === 'es' ? 'Sin respuesta.' : 'No reply.');

    botDiv.textContent = reply;
    speak(reply);
  } catch (err) {
    const fallback = (lang === 'es')
      ? 'Error: no puedo conectar con el asistente OPS.'
      : 'Error: can’t reach OPS assistant.';
    botDiv.textContent = fallback;
    speak(fallback);
  }
};
</script>
</body>
</html>
