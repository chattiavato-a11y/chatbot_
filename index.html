<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>OPS Online Support</title>

<!-- Strict CSP: self-only; inline script via nonce; connect only to your gateway.
     NOTE: The `frame-ancestors` directive must be delivered via an HTTP response header.
     It is intentionally omitted here to avoid browser warnings; configure it server-side. -->
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
    base-uri 'self';
    object-src 'none';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    font-src 'self' data:;
    frame-src 'self';
    connect-src 'self' https://ops-gateway.grabem-holdem-nuts-right.workers.dev;
    form-action 'self';
    worker-src 'self';
    script-src 'self' 'nonce-ops-inline-asset';
    upgrade-insecure-requests;">

<meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), interest-cohort=()">
<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
<meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

<style>
:root {
  --clr-primary:#00c4ff;
  --clr-accent:#ff3bdb;
  --clr-bg:#ffffff;
  --clr-bg-dark:#121212;
  --clr-tx:#333333;
  --clr-tx-dark:#f0f0f0;
}
body {
  margin:0; display:flex; align-items:center; justify-content:center;
  height:100vh; font-family:'Segoe UI',Arial,sans-serif;
  background:var(--clr-bg); color:var(--clr-tx); transition:background .3s,color .3s;
}
body.dark { --clr-bg:var(--clr-bg-dark); --clr-tx:var(--clr-tx-dark); }

#chatbot-container {
  width:300px; height:540px; background:#251541;
  border:2px solid var(--clr-accent); border-radius:18px; box-shadow:0 8px 32px #0006;
  display:flex; flex-direction:column; overflow:hidden;
}
#chatbot-header {
  display:flex; justify-content:center; align-items:center; gap:.5rem;
  background:linear-gradient(135deg,var(--clr-primary) 0%,var(--clr-accent) 100%);
  color:#fff; font-weight:600; font-size:1.1rem; padding:.75rem 1rem;
}
.ctrl-group { display:flex; align-items:center; gap:.35rem; flex-wrap:wrap; }
.ctrl {
  cursor:pointer; font-size:.75rem; font-weight:600; user-select:none; opacity:.9; color:#fff;
  background:#321b53; border:1px solid #fff3; border-radius:6px; padding:.25rem .55rem;
  transition:background .2s, color .2s, opacity .2s, box-shadow .2s;
}
.ctrl:hover { opacity:1; background:#3d2264; }
.ctrl.active { background:#fff; color:#321b53; opacity:1; box-shadow:0 0 0 1px #fff4; }

.icon { width:1em; height:1em; display:inline-block; vertical-align:-0.15em; fill:currentColor; }

#chat-log {
  flex:1; overflow-y:auto; padding:1rem; background:#1b0e2d; color:#eee; font-size:.94rem;
}
.chat-msg { margin:.5rem 0; max-width:90%; }
.user { margin-left:auto; background:var(--clr-primary); color:#000; padding:.5rem .7rem; border-radius:14px 14px 0 14px; }
.bot  { margin-right:auto; background:#321b53; color:#fff; padding:.5rem .7rem; border-radius:14px 14px 14px 0; }

#chatbot-form-container { background:#220f3a; border-top:1px solid var(--clr-accent); padding:.55rem .7rem .75rem; color:#fff; }
#control-row { display:flex; justify-content:flex-start; margin-bottom:.55rem; }
#chatbot-input-row { display:flex; gap:.6rem; }

#listenCtrl {
  background:#ffb703; border:none; color:#1b0e2d; font-weight:700;
  padding:.45rem .65rem; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:transform .2s, box-shadow .2s;
}
#listenCtrl .btn-label { margin-left:.35rem; font-weight:700; }
#listenCtrl.active { box-shadow:0 0 0 2px #fff3; transform:scale(1.02); }

#chatbot-input { flex:1; background:transparent; border:none; color:#fff; font-size:.95rem; padding:.55rem .6rem; }
#chatbot-input::placeholder { color:#bfbfbf; }

#chatbot-send {
  display:flex; align-items:center; gap:6px; background:var(--clr-accent); border:none; color:#fff;
  font-weight:600; padding:.5rem .9rem; border-radius:8px; cursor:pointer; transition:.3s;
}
#chatbot-send .icon { transition:transform .3s; }
#chatbot-send:hover .icon { transform:rotate(-45deg); }

  #tnc-row { display:flex; justify-content:flex-end; margin-top:.4rem; }
  #tnc-trigger {
  background:transparent; color:#fff; border:1px solid #ffffff40; border-radius:8px; padding:.35rem .7rem;
    font-weight:600; cursor:pointer; transition:background .2s, color .2s, border-color .2s;
  }
  #tnc-trigger:hover, #tnc-trigger:focus-visible { background:#ffffff12; border-color:#ffffff70; }

  #voice-status {
    margin:0.25rem 0 0.35rem;
    font-size:.83rem;
    color:#f5f7fb;
    opacity:.9;
    min-height:1.2em;
  }

#tnc-modal {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.75); backdrop-filter:blur(2px); z-index:2000;
}
#tnc-modal.active { display:flex; }
#tnc-dialog {
  background:#f8f8ff; color:#1b0e2d; width:92%; max-width:520px; border-radius:16px; padding:1.4rem 1.2rem 1.2rem;
  box-shadow:0 12px 36px rgba(0,0,0,0.35); border:2px solid var(--clr-primary);
}
#tnc-dialog h3 { margin-top:0; margin-bottom:.6rem; color:#1b0e2d; }
#tnc-dialog p { margin:.35rem 0; line-height:1.5; }

#consent-banner {
  background:#0d0b1e; color:#f5f7fb; border:2px solid var(--clr-primary); border-radius:14px; padding:1rem 1.25rem;
  margin:0 0 1rem; box-shadow:0 10px 25px #0005;
}
#consent-banner a { color:var(--clr-primary); font-weight:600; }
#consent-banner .consent-row { display:flex; align-items:center; gap:.65rem; margin-top:.75rem; flex-wrap:wrap; }
#consentToggle { width:18px; height:18px; }
#consent-status { font-size:.95rem; }

#tnc-close {
  display:inline-flex; align-items:center; gap:.25rem; margin-top:1rem; background:#var(--clr-primary); color:#0d0b1e;
  border:none; border-radius:10px; padding:.45rem .8rem; font-weight:700; cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}
</style>
</head>
<body>

<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header">
    <span id="title" data-en="OPS Online Support" data-es="Soporte en línea OPS">OPS Online Support</span>
  </div>

  <div id="chat-log" aria-live="polite"></div>

  <div id="chatbot-form-container">
    <div id="control-row" class="ctrl-group" aria-label="Language, theme, and speech controls">
      <button type="button" id="langCtrl" class="ctrl"
        aria-label="Toggle language" data-en-label="Toggle language" data-es-label="Cambiar idioma">EN</button>
      <button type="button" id="themeCtrl" class="ctrl">Dark</button>
      <button type="button" id="speechToggle" class="ctrl" data-en="Speech" data-es="Voz">Speech</button>
      <button id="listenCtrl" type="button" aria-label="Start voice input"
        data-en-label="Start voice input" data-es-label="Comenzar voz">
        <!-- Mic SVG -->
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z"/>
        </svg>
        <span class="btn-label" data-en="Speak" data-es="Hablar">Speak</span>
      </button>
    </div>
    <div id="voice-status" role="status" aria-live="polite"></div>
    <form id="chatbot-input-row" autocomplete="off">
      <input id="chatbot-input" type="text" placeholder="Type your message..." required maxlength="256"
        data-en-ph="Type your message..." data-es-ph="Escriba su mensaje...">
      <button id="chatbot-send" type="submit" aria-label="Send">
        <!-- Paper plane SVG -->
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M2 21l20-9L2 3v7l14 2L2 14v7z"/>
        </svg>
      </button>
    </form>
    <div id="tnc-row">
      <button id="tnc-trigger" type="button" aria-haspopup="dialog" aria-controls="tnc-modal"
        data-en="Consent Notice" data-es="Aviso de consentimiento">Consent Notice</button>
    </div>
  </div>
</div>

<div id="tnc-modal" role="dialog" aria-modal="true" aria-labelledby="tnc-title" aria-hidden="true">
  <div id="tnc-dialog">
    <h3 id="tnc-title" data-en="Consent Notice &amp; Terms" data-es="Aviso de consentimiento y términos">
      Consent Notice &amp; Terms
    </h3>
    <div id="consent-banner" role="region" aria-live="polite">
      <p data-en="We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our"
         data-es="Procesamos tu chat y la entrada de voz opcional para responder. El audio permanece en tu navegador; los mensajes escritos se envían a nuestro servicio. Revisa nuestra">
        We process your chat and optional voice input to respond. Audio stays in your browser; typed messages are sent to our service. Please review our
        <a href="#" target="_blank" rel="noreferrer noopener">Privacy Policy</a> &amp;
        <a href="#" target="_blank" rel="noreferrer noopener">Terms of Service</a>
        before proceeding.
      </p>
      <p data-en="Grant consent to enable voice controls and sending messages to the assistant."
         data-es="Otorga consentimiento para activar los controles de voz y el envío de mensajes al asistente.">
        Grant consent to enable voice controls and sending messages to the assistant.
      </p>
      <div class="consent-row">
        <label for="consentToggle"
          data-en="I consent to send my messages for processing."
          data-es="Consiento enviar mis mensajes para su procesamiento.">
          I consent to send my messages for processing.
        </label>
        <input type="checkbox" id="consentToggle" aria-describedby="consent-status">
        <span id="consent-status"></span>
      </div>
    </div>
    <button id="tnc-close" type="button" aria-label="Close terms dialog">Close</button>
  </div>
</div>

<!-- Inline script; the nonce must match the CSP above -->
<script nonce="ops-inline-asset">
(() => {
  const qs  = s => document.querySelector(s);
  const qsa = s => [...document.querySelectorAll(s)];

  /* ===== Fixed asset ID header ===== */
  const ASSET_ID = "CAFF600A21B457E5D909FD887AF48018B3CBFDDF6F9746E56238B23AF061F9E2";

  /* ===== HARD LOCK: exact origin + exact path prefix ===== */
  const EXPECTED_ORIGIN = "https://chattiavato-a11y.github.io";   // scheme + host only
  const ALLOWED_PATH_PREFIX = "/ops-online-support/";             // required path prefix
  const atExpectedOrigin = (self.origin === EXPECTED_ORIGIN);
  const atExpectedPath   = (self.location.pathname.startsWith(ALLOWED_PATH_PREFIX));
  const fullyAuthorized  = atExpectedOrigin && atExpectedPath;

  /* ===== Gateway endpoint (ops-gateway) ===== */
  const API_URL = new URL("https://ops-gateway.grabem-holdem-nuts-right.workers.dev/api/ops-online-chat");

  /* ===== UI refs ===== */
  const langCtrl     = qs('#langCtrl');
  const transNodes   = qsa('[data-en]');
  const phNodes      = qsa('[data-en-ph]');
  const ariaNodes    = qsa('[data-en-label]');

  const themeCtrl     = qs('#themeCtrl');
  const speechToggle  = qs('#speechToggle');
  const listenCtrl    = qs('#listenCtrl');

  const voiceStatus   = qs('#voice-status');

  const log   = qs('#chat-log');
  const form  = qs('#chatbot-input-row');
  const input = qs('#chatbot-input');

  const consentToggle = qs('#consentToggle');
  const consentStatus = qs('#consent-status');
  const sendBtn       = qs('#chatbot-send');

  const tncTrigger = qs('#tnc-trigger');
  const tncModal   = qs('#tnc-modal');
  const tncClose   = qs('#tnc-close');

  const CONSENT_KEY = 'opsChatConsent_v1';
  let consentGranted = localStorage.getItem(CONSENT_KEY) === 'true';

  let currentLang = document.documentElement.lang === 'es' ? 'es' : 'en';

  const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = Recognition ? new Recognition() : null;
  const speechSupported = !!synth;
  const recognitionSupported = !!recognition;

  let listening = false;
  let speechEnabled = false;

  /* ===== Security helpers ===== */
  function normalizeUserText(s) {
    let out = String(s || '');
    out = out.replace(/[\u0000-\u001F\u007F]/g, ' ');
    out = out.replace(/\s+/g, ' ').trim();
    if (out.length > 256) out = out.slice(0, 256);
    return out;
  }
  function cleanForSpeech(s) {
    let out = String(s || '');
    out = out.replace(/`{3}[\s\S]*?`{3}/g, ' ');     // remove code blocks
    out = out.replace(/`([^`]+)`/g, '$1');             // inline code
    out = out.replace(/[*_~]+/g, '');                  // emphasis markers
    out = out.replace(/^-\s+/gm, '');                 // list dashes
    out = out.replace(/\s+/g, ' ').trim();
    return out;
  }
  function looksSuspicious(s) {
    const t = String(s || '').toLowerCase();
    const bad = [
      "<script", "</script", "javascript:",
      "<img", "onerror", "onload",
      "<iframe", "<object", "<embed",
      "<svg", "<link", "<meta", "<style",
      "document.cookie",
      "onmouseover", "onmouseenter",
      "<form", "<input", "<textarea"
    ];
    return bad.some(p => t.includes(p));
  }
  function requireConsentMessage() {
    return currentLang === 'es'
      ? 'Activa el consentimiento para usar voz o enviar mensajes.'
      : 'Please enable consent to use voice or send messages.';
  }
  function addMsg(txt, cls) {
    const div = document.createElement('div');
    div.className = 'chat-msg ' + cls;
    div.textContent = txt;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
    return div;
  }
  function setVoiceStatus(enText, esText) {
    if (!voiceStatus) return;
    voiceStatus.textContent = (currentLang === 'es') ? (esText || enText) : enText;
  }

  /* ===== Show lock message if not fully authorized ===== */
  if (!fullyAuthorized) {
    addMsg(
      (currentLang === 'es')
        ? 'Bloqueado: solo se permite desde https://chattiavato-a11y.github.io/ops-online-support/.'
        : 'Blocked: only allowed from https://chattiavato-a11y.github.io/ops-online-support/.',
      'bot'
    );
  }

  /* ===== Consent + UI state ===== */
  function updateSpeechToggleUI() {
    speechToggle.classList.toggle('active', speechEnabled);
    speechToggle.setAttribute('aria-pressed', speechEnabled ? 'true' : 'false');
  }
  function updateListenUI() {
    listenCtrl.classList.toggle('active', listening);
    listenCtrl.setAttribute('aria-pressed', listening ? 'true' : 'false');
  }
  function updateVoiceStatus() {
    if (!consentGranted) {
      setVoiceStatus('Enable consent to use voice.', 'Activa el consentimiento para usar voz.');
      return;
    }
    if (!fullyAuthorized) {
      setVoiceStatus('Voice is locked to the authorized site path.', 'La voz está restringida a la ruta autorizada.');
      return;
    }
    if (!speechSupported && !recognitionSupported) {
      setVoiceStatus('Voice features are not supported in this browser.', 'Las funciones de voz no son compatibles con este navegador.');
      return;
    }

    const parts = [];
    if (speechSupported) {
      parts.push(
        speechEnabled
          ? (currentLang === 'es' ? 'Lectura por voz activada.' : 'Speech output on.')
          : (currentLang === 'es' ? 'Lectura por voz apagada.' : 'Speech output off.')
      );
    }
    if (recognitionSupported) {
      parts.push(
        listening
          ? (currentLang === 'es' ? 'Escuchando…' : 'Listening…')
          : (currentLang === 'es' ? 'Micrófono listo.' : 'Microphone ready.')
      );
    }
    setVoiceStatus(parts.join(' '));
  }
  function updateConsentUI() {
    consentToggle.checked = consentGranted;
    const consentNeeded = !consentGranted;

    // hard block input/send when not fully authorized
    const blocked = consentNeeded || !fullyAuthorized;

    speechToggle.disabled = blocked || !speechSupported;
    listenCtrl.disabled   = blocked || !recognitionSupported;
    sendBtn.disabled      = blocked;
    input.disabled        = blocked;

    const statusText = consentGranted
      ? (currentLang === 'es'
        ? 'Consentimiento activo: puedes usar voz y enviar mensajes.'
        : 'Consent granted: voice and messages are enabled.')
      : (currentLang === 'es'
        ? 'Activa el consentimiento para habilitar voz y envíos.'
        : 'Turn on consent to enable voice and sending.');

    consentStatus.textContent = statusText;
    consentStatus.setAttribute('aria-live', 'polite');
    updateVoiceStatus();
  }
  function setConsent(granted) {
    consentGranted = !!granted;
    localStorage.setItem(CONSENT_KEY, consentGranted ? 'true' : 'false');
    updateConsentUI();
  }

  /* ===== T&C dialog ===== */
  function openTncDialog(){ tncModal?.classList.add('active'); tncModal?.setAttribute('aria-hidden','false'); tncClose?.focus(); }
  function closeTncDialog(){ tncModal?.classList.remove('active'); tncModal?.setAttribute('aria-hidden','true'); tncTrigger?.focus(); }

  consentToggle.addEventListener('change', () => setConsent(consentToggle.checked));
  tncTrigger.addEventListener('click', openTncDialog);
  tncClose.addEventListener('click', closeTncDialog);
  tncModal.addEventListener('click', e => { if (e.target === tncModal) closeTncDialog(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && tncModal.classList.contains('active')) closeTncDialog(); });

  /* ===== Language, theme, speech, listen ===== */
  function setLanguage(lang) {
    const toES = lang === 'es';
    currentLang = toES ? 'es' : 'en';
    document.documentElement.lang = currentLang;

    langCtrl.textContent = toES ? 'ES' : 'EN';
    langCtrl.setAttribute('aria-pressed', toES ? 'true' : 'false');
    langCtrl.classList.toggle('active', toES);

    transNodes.forEach(node => { node.textContent = toES ? node.dataset.es : node.dataset.en; });
    phNodes.forEach(node => { node.placeholder = toES ? node.dataset.esPh : node.dataset.enPh; });
    ariaNodes.forEach(node => { node.setAttribute('aria-label', toES ? node.dataset.esLabel : node.dataset.enLabel); });

    if (recognition) recognition.lang = toES ? 'es-ES' : 'en-US';
    updateConsentUI();
    updateVoiceStatus();
  }
  langCtrl.addEventListener('click', () => setLanguage(currentLang === 'es' ? 'en' : 'es'));

  themeCtrl.onclick = () => {
    const dark = themeCtrl.textContent === 'Dark';
    document.body.classList.toggle('dark', dark);
    themeCtrl.textContent = dark ? 'Light' : 'Dark';
  };

  function getVoiceForLang(langCode) {
    if (!synth) return null;
    const voices = synth.getVoices();
    const want = langCode === 'es' ? ['es-', 'es_'] : ['en-', 'en_'];
    const preferred = voices
      .filter(v => want.some(p => (v.lang || '').toLowerCase().startsWith(p)))
      .sort((a,b)=>((b.localService?2:0)+(/google|microsoft|natural/i.test(b.name)?1:0))-((a.localService?2:0)+(/google|microsoft|natural/i.test(a.name)?1:0)));
    return preferred[0] || null;
  }
  function speak(text) {
    if (!synth || !speechEnabled) return;
    const clean = cleanForSpeech(normalizeUserText(text));
    if (!clean) return;
    synth.cancel();
    const u = new SpeechSynthesisUtterance(clean);
    u.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
    const v = getVoiceForLang(currentLang); if (v) u.voice = v;
    if (currentLang === 'en') { u.rate = 1.03; u.pitch = 1.02; }
    synth.speak(u);
    setVoiceStatus(
      'Speaking response…',
      'Hablando la respuesta…'
    );
    u.onend = () => updateVoiceStatus();
  }
  if (synth) synth.onvoiceschanged = () => getVoiceForLang(currentLang);

  if (recognition) {
    recognition.continuous = false; recognition.interimResults = false;
    recognition.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
    recognition.onstart = () => { listening = true; updateListenUI(); updateVoiceStatus(); };
    recognition.onresult = e => {
      const transcript = e.results?.[0]?.[0]?.transcript || '';
      const cleaned = normalizeUserText(transcript);
      if (cleaned) {
        input.value = cleaned;
        input.focus();
        if (consentGranted && fullyAuthorized) {
          form.requestSubmit();
        }
      }
    };
    recognition.onerror = () => { listening = false; updateListenUI(); updateVoiceStatus(); };
    recognition.onend   = () => { listening = false; updateListenUI(); updateVoiceStatus(); };
  }
  function startListening(){
    if (!recognition) return;
    recognition.lang = currentLang==='es'?'es-ES':'en-US';
    listening=true;
    updateListenUI();
    setVoiceStatus('Listening…', 'Escuchando…');
    recognition.start();
  }

  speechToggle.onclick = () => {
    if (!consentGranted) { addMsg(requireConsentMessage(),'bot'); return; }
    if (!synth) { addMsg(currentLang==='es'?'La síntesis de voz no está disponible.':'Speech synthesis is not available.','bot'); return; }
    speechEnabled = !speechEnabled; updateSpeechToggleUI();
    updateVoiceStatus();
  };
  listenCtrl.onclick = () => {
    if (!consentGranted) { addMsg(requireConsentMessage(),'bot'); return; }
    if (!recognition) { addMsg(currentLang==='es'?'Entrada por voz no disponible en este navegador.' : 'Voice input is not available in this browser.','bot'); return; }
    if (listening) { recognition.stop(); return; }
    startListening();
    updateVoiceStatus();
  };

  /* ===== Init ===== */
  setLanguage(currentLang);
  updateSpeechToggleUI();
  updateListenUI();
  updateConsentUI();

  /* ===== Submit: ONLY if fully authorized (origin + path) ===== */
  form.onsubmit = async e => {
    e.preventDefault();

    const raw = input.value;
    const msg = normalizeUserText(raw);
    if (!msg) return;

    if (!consentGranted) {
      addMsg(requireConsentMessage(), 'bot');
      return;
    }

    if (!fullyAuthorized) {
      addMsg(
        (currentLang === 'es')
          ? 'Por seguridad, los mensajes solo se envían desde la ruta autorizada.'
          : 'For security, messages are only sent from the authorized route.',
        'bot'
      );
      return;
    }

    if (looksSuspicious(msg)) {
      const warn = currentLang === 'es'
        ? 'Mensaje bloqueado por seguridad. Por favor escribe sin etiquetas o scripts.'
        : 'Message blocked for security. Please write without tags or scripts.';
      addMsg(warn, 'bot'); speak(warn); return;
    }

    // user bubble
    addMsg(msg, 'user');
    input.value = '';

    // temp bot bubble
    const botDiv = addMsg('…', 'bot');

    try {
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), 15000);

      const res = await fetch(API_URL.href, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        credentials: 'omit',
        redirect: 'error',
        referrerPolicy: 'no-referrer',
        headers: {
          'Content-Type': 'application/json',
          'X-Ops-Asset-Id': ASSET_ID
        },
        body: JSON.stringify({ message: msg, lang: currentLang, v: 1 }),
        signal: ctrl.signal
      });
      clearTimeout(to);

      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch {}

      if (!res.ok) {
        const fallback = currentLang==='es' ? 'Error del gateway de OPS.' : 'OPS gateway error.';
        const errMsg = (data && (data.error || data.public_error)) ? (data.error || data.public_error) : (text || fallback);
        botDiv.textContent = errMsg; speak(errMsg); return;
      }
      if (!data || typeof data !== 'object') {
        const fallback = currentLang==='es' ? 'Error: respuesta no válida del gateway.' : 'Error: invalid response from gateway.';
        botDiv.textContent = fallback; speak(fallback); return;
      }
      if (data.error || data.public_error) {
        const err = data.error || data.public_error; botDiv.textContent = err; speak(err); return;
      }

      const reply = (typeof data.reply === 'string' && data.reply.trim())
        ? data.reply.trim()
        : (currentLang==='es' ? 'Sin respuesta.' : 'No reply.');
      botDiv.textContent = reply;
      speak(reply);
    } catch {
      const fallback = currentLang==='es' ? 'Error: no puedo conectar con el asistente OPS.' : 'Error: can’t reach OPS assistant.';
      botDiv.textContent = fallback; speak(fallback);
    }
  };
})();
</script>
</body>
</html>


